---
title: "Análisis de autocorrelación espacial"
author: 
  -"Juan José Galeano Arenas"
  -"Simón Pedro Galeano Muñoz"
  -"Germán Alonso Patiño Hurtado"
date: 10/05/2022
output: 
  html_document:
    toc: true
    theme: paper
    code_folding: show
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, fig.align = "center",
                      message = F, results = T)
library(kableExtra)
library(knitr)
library(geoR)
library(readxl)
library(vegan)
library(raster)
library(spatstat)
library(leaflet)
```

# Contextualización

```{r echo=F}
# Bases de datos necesarias
datos_cools <- readRDS("datos.Rds")
```

# Datos

El invierno es feroz, más aún cuando de agricultura se trata. Indiana, estado 
precioso cuyo mayor costo de <a href="https://www.nass.usda.gov/Quick_Stats/Ag_Overview/stateOverview.php?state=INDIANA">producción agrícola</a> se debe al cultivo de maíz.

Motivados por este hecho, se tomó la decisión de investigar cuáles son
aquellas zonas en las que se presenta una mayor temperatura y una mayor
irradiación por parte de la radiación que emite la luz solar, ya que
el maíz es un vegetal que aprovecha mucho ambas características para
su <a href="https://www.pioneer.com/us/agronomy/soil_temp_corn_emergence.html#:~:text=Key%20Points,corn%20emergence%20and%20seedling%20health.">crecimiento y desarrollo</a>.


# Temperatura e irradiación solar 

Se miden las variables irradiación solar y temperatura en ubicaciones especificas del estado de indiana en estados unidos múltiples veces (90 en cada punto); dichas mediciones se realizan en ubicaciones igualmente espaciadas. 

Teniendo en cuenta que se tienen múltiples mediciones de las variables surge la necesidad de resumir esta información con alguna métrica puesto que en la teoría vista se considera una única realización del proceso estocástico, a continuación se muestran los histogramas de las variables consideradas.

# Base de datos definitiva

La base de datos definitiva se construye agrupando los datos por la longitud y latitud debido a que, como se mencionó previamente, se tienen múltiples mediciones de las variables en cada ubicación los cuales corresponden a los primeros tres meses del año, una vez agrupadas las ubicaciones, se promedian todos los valores medidos en dichas ubicaciones de las variables de interés, esto gracias a las funciones `group_by()` y `summarise()` de la librería `dplyr`. La base de datos resultante tiene la siguiente estructura

```{r}
mapa_base <- leaflet() %>%
  addTiles()

mapa_base %>% 
  addCircleMarkers(lat=~LAT, lng =~LON, 
                   color = "red", radius = 0.5, data = datos_cools)
```



## Análisis descriptivo y prueba de autocorrelación espacial

```{r}
datos_geo<- as.geodata(datos_cools,coords.col = 2:1, data.col = 4)
plot(datos_geo)
```

```{r}
distancia <- dist(cbind(datos_cools$LON,datos_cools$LAT),diag=TRUE,upper=TRUE)
dist.datos <- dist(datos_cools$Temperatura, diag=TRUE, upper=TRUE)^2
mantel(distancia, dist.datos) 
```
```{r}
summary(distancia)
variograma=variog(datos_geo,option = "bin",uvec = seq(0,2.9,0.3),messages=F)

## bandas de confianza, si hay o no autocorrelacion 
variograma.emv=variog.mc.env(datos_geo,obj=variograma)
```

```{r,results="hide"}
ini.vals <- expand.grid(seq(2,5,l=10), seq(2,2.9,l=10))
model_mco_exp=variofit(variograma, ini=ini.vals, cov.model="exponential",
                       wei="npair", min="optim")
model_mco_gaus=variofit(variograma, ini=ini.vals, cov.model="gaussian", wei="npair", min="optim",nugget = 0)
model_mco_spe=variofit(variograma, ini=ini.vals, cov.model="spheric",fix.nug=TRUE, wei="npair", min="optim")
```

```{r}
plot(variograma,envelope=variograma.emv,pch=19)
lines(model_mco_exp,col="blue")
lines(model_mco_gaus,col="red")
lines(model_mco_spe,col="purple")
```


```{r}
#valida = xvalid(datos_geo,model = model_mco_gaus)
#?xvalid
```




```{r}
x_obs <- c(min(datos_cools$LON), max(datos_cools$LON))
y_obs <- c(min(datos_cools$LAT), max(datos_cools$LAT))
obs_window <- owin(x_obs, y_obs)
```


# Interpolación IDW

```{r}
ppp_temp <- ppp(datos_cools$LON, datos_cools$LAT,
                 marks = datos_cools$Temperatura, window = obs_window)

idw_temp <- idw(ppp_temp, power = 0.05, at = "pixels")

plot(idw_temp,
     col = heat.colors(20), 
     main = "Interpolación IDW para la temperatura promedio") 
```

## MSE

# Cross - Validation

```{r}
par(mfrow=c(2,2))
plot(idw(ppp_temp, power=0.001, at="pixels"),
     col=heat.colors(20), main="power = 0.001") 

plot(idw(ppp_temp, power=0.01, at="pixels"),
     col=heat.colors(20), main="power = 0.01")

plot(idw(ppp_temp, power=0.1, at="pixels"),
     col=heat.colors(20), main="power = 0.1")

plot(idw(ppp_temp, power=10, at="pixels"),
     col=heat.colors(20), main="power = 10") 
```

## Buscando la potencia óptima

```{r}
powers <- seq(0.001, 10, 0.01)
mse_result <- NULL
for(power in powers){
  CV_idw <- idw(ppp_temp, power=power, at="points")
  mse_result <- c(mse_result,
                  Metrics::mse(ppp_temp$marks, CV_idw))
}
optimal_power <- powers[which.min(mse_result)]
optimal_power

plot(powers, mse_result)
powers[which.min(mse_result)]
```

```{r}
idw_temp_optimo <- idw(ppp_temp, power = 1.411, at = "pixels")

plot(idw_temp_optimo,
     col = heat.colors(20), 
     main = "Interpolated spatial variation in risk of malaria based on IDW method \n (Power = 0.05)") 

```





